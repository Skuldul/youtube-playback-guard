#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

ENV_FILE="$REPO_ROOT/.env.local"

if [[ -f "$ENV_FILE" ]]; then
  source "$ENV_FILE"
fi

if ! command -v npm >/dev/null 2>&1; then
  echo "Error: npm is not installed."
  echo
  exit 1
fi

if [[ ! -x "$REPO_ROOT/node_modules/.bin/chrome-webstore-upload" ]]; then
  echo "Error: dependencies not installed. Run 'npm install' first."
  echo
  exit 1
fi

: "${CLIENT_ID:?CLIENT_ID not set}"
: "${CLIENT_SECRET:?CLIENT_SECRET not set}"
: "${REFRESH_TOKEN:?REFRESH_TOKEN not set}"
: "${EXTENSION_ID:?EXTENSION_ID not set}"

npm run build:chrome

SOURCE_CODE_ZIP_DIR="$REPO_ROOT/web-ext-artifacts/source-code"

source "$SCRIPT_DIR/zip-source-code"
zip_source_code "$REPO_ROOT" "$SOURCE_CODE_ZIP_DIR"

npx chrome-webstore-upload \
  --source "$REPO_ROOT/dist/chrome" \
  "$@"
